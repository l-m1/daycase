<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <script>
    // const promise = new Promise(function(resolve,reject) {
    //   if(/* 异步操作成功 */) {
    //     resolve(value);
    //   } else {
    //     reject(error);
    //   }
    // });

    // promise.then(function(value) {
    //   //success
    // },function(error) {
    //   //failure
    // });
    // function timeout(ms) {
    //   return new Promise((resolve,reject) => {
    //     setTimeout(resolve,ms,'done');
    //   });
    // }
    // timeout(100).then((value) => {
    //   console.log(value);
    // });

    // let promise = new Promise(function(resolve,reject) {
    //   console.log('Promise');
    //   resolve();
    // });
    // promise.then(function() {
    //   console.log('resolved.');
    // });
    // console.log('Hi!');  // Promise Hi! resolved.

    //异步加载图片
    // function loadImageAsync(url) {
    //   return new Promise(function(resolve,reject) {
    //     const image = new Image();
    //     image.onload = function() {
    //       resolve(image);
    //     };
    //     image.onerror = function() {
    //       reject(new Error('Could not load image at' + url));
    //     };
    //     image.src = url;
    //   });
    // }

    //使用Promise对象实现Ajax例子
    // const getJSON = function(url) {
    //   const promise = new Promise(function(resolve,reject) {
    //     const handler = function() {
    //       if(this.readyState !== 4) {
    //         return;
    //       }
    //       if(this.status === 200) {
    //         resolve(this.response);
    //       } else {
    //         reject(new Error(this.statusText));
    //       }
    //     };
    //     const client = new XMLHttpRequest();
    //     client.open('GET',url);
    //     client.onreadystatechange = handler;
    //     client.responseType = 'json';
    //     client.sentRequestHeader('Accept','application/json');
    //     client.send();
    //   });
    //   return promise;
    // };
    // getJSON('/posts.json').then(function(json) {
    //   console.log('Contents:' + json);
    // },function(error) {
    //   console.error('出错了',error);
    // })

    // const p1 = new Promise(function(resolve,reject) {
    //   setTimeout(() => reject(new Error('fail')),3000)
    // })
    // const p2 = new Promise(function(resolve,reject) {
    //   setTimeout(() => resolve(p1),1000)
    // })
    // p2.then(result => console.log(result))
    // .catch(error => console.log(error))
    // new Promise((resolve,reject) => {
    //   resolve(1);
    //   console.log(2);
    // }).then(r => {
    //   console.log(r); 
    // }); // 2 1
    //方法
    // getJSON('/posts.json').then(function(json) {
    //   return json.post;
    // }).then(function(post) {

    // });
    //链式调用
    // getJSON('/post/1.json').then(function(post) {
    //   return getJSON(post.commentURL);
    // }).then(function(comments) {
    //   console.log('resolved:',comments);
    // },function(err) {
    //   console.log('rejected:',err);
    // });

    // getJSON('/post/1.json').then(
    //   post => getJSON(post.commentURL)
    // ).then(
    //   comments => console.log('resolved:',comments),
    //   err => console.log('rejected:',err)
    // )

    // getJSON('/post.json').then(function(posts) {

    // }).catchy(function(error) {
    //   console.log('发生错误！',error);
    // })

    // const promise = new Promise(function(resolve,reject) {
    //   throw new Error('test');
    // });
    // promise.catch(function(error) {
    //   console.log(error);
    // })
    //等同于
    // const promise = new Promise(function(resolve,reject) {
    //   try{
    //     throw new Error('test');
    //   } catch(e) {
    //     reject(e);
    //   }
    // });
    // promise.catch(function(error) {
    //   console.log(error);
    // })//或者
    // const promise = new Promise(function(resolve,reject) {
    //   reject(new Error('test'));
    // });
    // promise.catch(error => console.log(error));
    // const promise = new Promise(function(resolve,reject) {
    //   resolve('ok');
    //   throw new Error('test');
    // });
    // promise
    // .then(value => console.log(value))
    // .catch(err => console.log(error));
    //冒泡机制 向后传递
    // getJSON('/post/1.json').then(function(post) {
    //    return getJSON(post.commentURL);
    // }).then(function(comments) {

    // }).catch(function(error) {
    //   //处理前面三个promise产生的错误
    // });
    // const promise = new Promise(function(resolve,reject) {

    // })
    // promise
    // .then(function(data) {
    //   //success
    // },function(err) {
    //   //error
    // });
    // promise
    // .then(function(data) {
    //   //success
    // })
    // .catch(function(err) {
    //   //error
    // });

    // const someAsyncThing = function() {
    //   return new Promise(function(resolve,reject) {
    //     resolve(x + 2);
    //   });
    // };
    // someAsyncThing().then(function() {
    //   console.log('everything is great');
    // });
    // setTimeout(() => {console.log(123)},2000); // 报错 x is not undefined 123

    // const promise = new Promise(function(resolve,reject) {
    //   resolve('ok');
    //   setTimeout(function() {
    //     throw new Error('test')
    //   },0)
    // });
    // promise.then(function(value) {
    //   console.log(value);
    // }) //ok 报错

    // const someAsyncThing = function() {
    //   return new Promise(function(resolve,reject) {
    //     resolve(x + 2);
    //   });
    // };
    // someAsyncThing()
    // .catch(function(error) {
    //   console.log('oh no',error);
    // })
    // .then(function() {
    //   console.log('carry on');
    // }); // x is not defined carry on

    // Promise.resolve()
    // .catch(function(error) {
    //   console.log('oh no',error);
    // })
    // .then(function() {
    //   console.log('carry on');
    // })  // carry on

    // const someAsyncThing = function() {
    //   return new Promise(function(resolve,reject) {
    //     resolve(x + 2); // x 未声明
    //   });
    // };
    // someAsyncThing().then(function() {
    //   return someOtherAsyncThing();
    // }).catch(function(error) {
    //   console.log('oh no',error);
    //   y + 2;//y 未声明
    // }).then(function() {
    //   console.log('carry on');
    // });
    // Promise.prototype.finally = function(callback) {
    //   let p = this.constructor;
    //   return this.then(
    //     value => p.resolve(callback()).then(() => value),
    //     reason => p.resolve(callback()).then(() => {throw reason})
    //   );
    // }; //promise会返回原来的值
    // Promise.resolve(2).then(() => {},() => {}) // undefined
    // Promise.resolve(2).finally(() => {})  // 2

    // const promises = [2,3,4,5,6,7,9].map(function(id) {
    //   return getJSON('/post/1.json');
    // });
    // Promise.all(promises).then(function(posts) {

    // }).catch(function(reason) {});

    const databasePromise = connectDatabase();
    
    const booksPromise = databasePromise
    .then(findAllBooks);

    const userPromise = databasePromise
    .then(getCurrentUser);
    Promise.all([
      booksPromise,
      userPromise
    ])
    .then(([books,user]) => pickTopRecommendation(books,user));































  </script>
</body>
</html>